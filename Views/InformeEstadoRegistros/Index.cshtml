@using ManteniWeb.Models;
@using ManteniWeb.Code
@using ManteniWeb.App_GlobalResources

@model List<DatosCampanaInformesEstado>



@{
    ViewBag.Title = CampanaResources.cmp_titInformeEstadosRegistros;
}

<link href="~/Content/bootstrap-select.min.css" rel="stylesheet" />
<link href='~/css/footable.core.css' rel='stylesheet' type='text/css' />
<link href="~/css/footableManteniWeb.metro.css" rel="stylesheet" />
<link href="~/css/StyleSheet1.css" rel="stylesheet" />
<style>
</style>

<script src="~/Scripts/bootstrap-select.js" type="text/javascript"></script>

@* TITULO DE LA PÁGINA *@
<div class="jumbotron">
    <div class="container">
        <div class="row rowSinMarginLateral">
            <div class="col-md-2"></div>
            <div class="col.md-8 TituloGrandeD" id="DivTituloGrande">
                <h2 class='tituloGrande visible-lg visible-md'>
                    <i class='fa fa-th' aria-hidden="true"></i>
                    <span style='margin-left: 1em;'>@ViewBag.Title</span>
                </h2>
            </div>
        </div>
    </div>
</div>


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken();

    @* ********************************************************************************************************************
         DIVIDO LA PÁGINA EN TRES PANELES, COMO EL RESTO DE LA APLICACIÓN , IzQUIERDA 2 , CENTRO 8, DERECHA 2
        ******************************************************************************************************************** *@
    <div class="row">
        @* LATERAL IZQUIERDO DE DOS POSICIONES *@
        <div class="col-md-2 col-xs-12">
            <div class='row rowSeparacion25'>
                <div class="col-md-10 col-sm-10">
                    <ul id="VerticalPill_opciones" class="nav nav-pills nav-stacked VerticalPillMenuRegistro">
                        <li></li>
                        <li class="RowAccionesSiempreVisibles">
                            <a href="#" role="button" id="OptionButtonVP_15" class="" onclick="RetrocederPaginaMVC();">
                                <div class="row">
                                    <div class="col-lg-2 col-sm-1">
                                        <span class="fa fa-arrow-left   visible-lg  visible-md  visible-xs " aria-hidden="true"></span>
                                    </div>
                                    <div class="col-lg-10 col-sm-11">Volver</div>
                                </div>
                            </a>
                        </li>
                        <li></li>
                    </ul>
                </div>
            </div>
        </div>


        @* ****************************************************************************
             CENTRO DE LA APLICACIÓN, DONDE VA EL CONTENIDO 8 POSICIONES
            **************************************************************************** *@
        <div class="col-md-8 col-xs-12">
            <div class="row rowSeparacion25">
                <div class="col-md-4">
                    <label for="SelectCampanas" id="labelSelectCampanas">@CampanaResources.cmp_campana <span style="color:red;">*</span></label>
                    <select id="SelectCampanas" multiple name="SelectCampanas" class='form-control' style="height:350px;">
                        <optgroup label="@ComunResources.chk_activo">
                            @foreach (DatosCampanaInformesEstado campana in Model)
                            {
                                if (campana.Activa)
                                {
                                    string selected = "";
                                    if (campana.Seleccionada)
                                    {
                                        selected = "selected";
                                    }

                                    <option @selected value="@campana.Idcampana">@campana.AliasCampana</option>
                                }
                            }
                        </optgroup>
                        @{
                            bool hayIncativas = false;
                            foreach (DatosCampanaInformesEstado campana in Model)
                            {
                                if (!campana.Activa)
                                {
                                    hayIncativas = true;
                                    break;
                                }
                            }
                        }

                        @if (hayIncativas)
                        {
                            <optgroup label="@ComunResources.chk_inactivo">
                                @foreach (DatosCampanaInformesEstado campana in Model)
                                {
                                    if (!campana.Activa)
                                    {
                                        string selected = "";
                                        if (campana.Seleccionada)
                                        {
                                            selected = "";
                                        }

                                        <option @selected value="@campana.Idcampana">@campana.AliasCampana</option>
                                    }
                                }
                            </optgroup>
                        }
                    </select>

                </div>
                <div class="col-md-3">
                    <label for="EstadoRegistro" id="labelEstadoRegistro">@CampanaResources.bs_estadoRegistro </label>
                    <select id="EstadoRegistro" multiple name="EstadoRegistro" class='form-control' style="height:110px;">
                        <option value="F">@CampanaResources.cmp_finalizado</option>
                        <option value="C">@CampanaResources.cmp_cancelado</option>
                        <option value="R">@CampanaResources.cmp_reprogramado</option>
                        <option value="N">@CampanaResources.cmp_noTocado</option>
                        <option value="D">@CampanaResources.cmp_devuelto</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="button" style="margin-top:25px;margin-left:0px;" class="btn btn-default" title="Exportar datos" id="BotonExportar" onclick="ExportarDatos()">@CampanaResources.cmp_exportarDatos</button>
                </div>

            </div>
        </div>

        @* PARTE DERECHA DEL FORMULARIO - 2 POSICIONES *@
        <div class="col-md-2 col-xs-12">

        </div>

    </div> @* FIN PANEL GENERAL DEL FORMULARIO *@
}

<script>
    $('.selectpicker').selectpicker('show');
</script>


@section scripts
{

    <script>
        let language = @WebConfigParams.AppLanguage;

        function ExportarDatos() {

            var idsCampanas = $('#SelectCampanas').val();
            var estados = $('#EstadoRegistro').val();
            var myurl = getRutaAbsolutaMVC();

            // Validamos que se hayan seleccionado campañas y estados para buscar
            if (idsCampanas == null || idsCampanas.length == 0) {
                // De momento así, pero habra que usar i18next
                if (language === 'es')
                    alert("Debe seleccionar al menos una campaña");
                else
                    alert("You must select at least one campaign");

                return;
            }

            $.ajax({
                type: "POST",
                url: myurl + "/InformeEstadoRegistros/ExportarDatos",
                data: JSON.stringify({ Campanas: idsCampanas, Estados: estados }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
            }).done(function (data) {
                //get the file name for download
                if (data.fileName != "") {
                    //descarga del fichero de la ruta y su posterior eliminación de la ruta una vez descargado
                    window.location.href = "@Url.RouteUrl(new  { Controller = "InformeEstadoRegistros", Action = "Download"})/?file=" + data.fileName;
                }
                else {
                    alert(data.errorMessage);
                }
            });

        }
    </script>

}