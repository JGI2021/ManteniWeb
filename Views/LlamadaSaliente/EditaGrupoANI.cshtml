

@using ManteniWeb.ClasesDeDatos;
@using ManteniWeb.Models
@using ManteniWeb.Code

@model  MarcacionesGrupoANI

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css" />
<link href="~/Content/DataTables/datatables.min.css" rel="stylesheet" />
<link href="~/Content/DataTables/DataTables-1.12.1/css/dataTables.jqueryui.min.css" rel="stylesheet" />
<link rel="stylesheet" href="~/css/ReglaLlamadaSaliente.css" />

<style>
    .div-table {
        padding-left: 15px;
        margin-right: -25px;
        margin-top: 35px;
    }

    .action-button {
        position: relative;
        padding: 4px 8px !important;
    }
</style>

@{
    string title = "Editar Grupo de teléfonos '" + Model.descripcion + "'";

    List<ReglaMarcacionPrefGrupo> reglasGruposPref = ViewBag.GrupoPrefijosReglas as List<ReglaMarcacionPrefGrupo>;
}

<div class="jumbotron fix-panel">
    <div class="container">
        <h2 class='tituloGrande visible-lg visible-md' style="font-family: inherit;">
            <i class='fa fa-th' aria-hidden="true"></i>
            <span style='margin-left: 1em;'>@title</span>
        </h2>
    </div>
</div>


<div class="container-fluid" style="font-size:16px;">
    <div class="row rowSeparacion25">

        <div class="col-lg-2 col-md-2">
            <div class="visible-lg visible-md rowSeparacion15">
                <ul id="VerticalPill_opciones" class="nav nav-pills nav-stacked">
                    <li></li>
                    <li class="EdicionSimple" style="display: none;">
                        <a href="#" role="button" id="OptionButtonVP_3" onclick="EditarRegistro();">
                            <div class="row">
                                <div class="col-lg-2 col-sm-2">
                                    <span class="fa @EstaticosImagenes.ImagenEdicionRegistro visible-lg visible-md visible-xs" aria-hidden="true"></span>
                                </div>
                                <div class="col-lg-10 col-sm-10">Editar</div>
                            </div>
                        </a>
                    </li>
                    <li class="RowAccionesSiempreVisibles" style="">
                        <a href="#" role="button" id="OptionButtonVP_15" onclick="RetrocederPaginaMVC();">
                            <div class="row">
                                <div class="col-lg-2 col-sm-1">
                                    <span class="fa @EstaticosImagenes.ImagenVolver visible-lg visible-md visible-xs" aria-hidden="true"></span>
                                </div>
                                <div class="col-lg-10 col-sm-11">Volver</div>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="col-lg-8 col-md-8">

            @Html.Partial("_MensajesError")

            @using (Html.BeginForm())
            {
                @Html.AntiForgeryToken()

                <div id="alerta" class="alert" style="display:none">
                    <a href="#" onclick="CloseAlert();" style="float: right;"><strong> X </strong></a>
                    <p id="alert-mensaje"></p>
                </div>

                <div class="row rowSeparacion20">
                    <div class="col-lg-7 col-md-7 caja-datos" style="margin-left: 30px;">

                        <div class="row rowSeparacion20 form-horizontal">
                            @{
                                string desactivado = string.IsNullOrEmpty(Model.aniGroupId) || Model.aniGroupId == "0" ? "" : "disabled";
                            }

                            <div class="form-group">
                                @Html.LabelFor(model => model.maxDiasTrabajo, htmlAttributes: new { @class = "control-label col-md-4", @style = "text-align: left; left:45px;" })
                                <div class="col-md-2">
                                    @Html.EditorFor(model => model.maxDiasTrabajo, new { htmlAttributes = new { @type = "number", @class = "form-control", onchange = "CambiaDatoGrupo('maxDiasTrabajo')" } })
                                    @Html.ValidationMessageFor(model => model.maxDiasTrabajo, "", new { @class = "text-danger" })
                                </div>
                            </div>

                            <div class="form-group">
                                @Html.LabelFor(model => model.aniGroupId, htmlAttributes: new { @class = "control-label col-md-4", @style = "text-align: left; left:45px;" })
                                <div class="col-md-5">
                                    @if (desactivado == "disabled")
                                    {
                                        @Html.TextBoxFor(model => model.aniGroupId, new { disabled = "disabled", @readonly = "readonly", @class = "form-control" })
                                    }
                                    else
                                    {
                                        @Html.EditorFor(model => model.aniGroupId, new { htmlAttributes = new { @class = "form-control", onchange = "CambiaDatoGrupo('aniGroupId')", maxlength = "50" } })
                                    }
                                    @Html.ValidationMessageFor(model => model.aniGroupId, "", new { @class = "text-danger" })
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.descripcion, htmlAttributes: new { @class = "control-label col-md-4", @style = "text-align: left; left:45px;" })
                                <div class="col-md-7">
                                    @Html.EditorFor(model => model.descripcion, new { htmlAttributes = new { @class = "form-control", @required = "required", onchange = "CambiaDatoGrupo('descripcion')" } })
                                    @Html.ValidationMessageFor(model => model.descripcion, "", new { @class = "text-danger" })
                                </div>
                            </div>

                        </div>

                        <div class="row div-table">
                            <div class="col-md-4"></div>
                            <div class="col-md-7">
                                <table id="tablaANIs" class="table table-borderless table-hover panel-tabla-ani">
                                    <thead>
                                        <tr>
                                            <th width="15%"><input type="checkbox" id="chk_todos" value="" /></th>
                                            <th width="70%">Teléfono</th>
                                            <th width="15%">
                                                <button type="button" class="btn btn-info action-button" onclick="AltaANIs()">
                                                    <span class="fa fa-plus"></span>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="bodyTablaANIs">
                                        @foreach (string ani in Model.ANIs)
                                        {
                                            <tr id="tr_@ani">
                                                <td><input type="checkbox" id="chk_@ani" value="" /></td>
                                                <td>@ani</td>
                                                <td>
                                                    <button type="button" class="btn btn-default action-button" onclick="EliminaANIDeGrupo('@ani')">
                                                        <span class="fa fa-trash" style="color:darkred;"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="row  main">
                            <div class="col-lg-11 col-md-11 col-sm-11">
                                <div class="floatRight">
                                    <button type="button" class="btn btn-default botonFicha" id="BotonAceptar" onclick="GuardarGrupoTelefonos(0)">Guardar</button>
                                    <button type="button" class="btn btn-default botonFicha" id="BotonAceptarSalir" onclick="GuardarGrupoTelefonos(1)">Guardar y salir</button>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="col-lg-4 col-md-4 caja-datos" style="margin-left: 30px;">
                        <h4><strong>Reglas y grupos asociados</strong></h4>
                        <div class="row div-table">
                            <table id="tablaAsociados" class="table table-borderless table-hover panel-tabla-ani">
                                <thead>
                                    <tr>
                                        <th>Regla</th>
                                        <th>Grupo ACD</th>
                                        <th>Prefijos</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyAsociados">
                                    @{
                                        var reglasAsociadas = reglasGruposPref.FindAll(r => r.currentAniGroupId == Model.aniGroupId);
                                    }
                                    @if (reglasAsociadas.Count == 0)
                                    {
                                        <tr>
                                            <td colspan="3">No hay reglas que usen el grupo de teléfonos</td>
                                        </tr>
                                    }
                                    else
                                    {
                                        foreach (ReglaMarcacionPrefGrupo regla in reglasAsociadas)
                                        {
                                            bool inicio = true;

                                            if (regla.grupoPrefijos.Count == 0)
                                            {
                                                <tr id="tr_@regla.regla-00">
                                                    <td>
                                                        <a href="javascript:AvanzarPagina('LlamadaSaliente/EditaGrupoANI?id=@Model.aniGroupId','LlamadaSaliente/EditaRegla?idRegla=@regla.regla')">
                                                            @regla.nombreRegla (@regla.regla)
                                                        </a>
                                                    </td>
                                                    <td> --- </td>
                                                    <td> --- </td>
                                                </tr>
                                            }

                                            foreach (GrupoPrefijo item in regla.grupoPrefijos)
                                            {
                                                string grupoAcd = " --- ";
                                                string prefijo = " --- ";
                                                if (item.grupoId != null)
                                                {
                                                    grupoAcd = item.grupoACD;
                                                    prefijo = item.prefijo;
                                                }

                                                if (inicio)
                                                {
                                                    <tr id="tr_@regla.regla-@item.grupoId">
                                                        <td>
                                                            <a href="javascript:AvanzarPagina('LlamadaSaliente/EditaGrupoANI?id=@Model.aniGroupId','LlamadaSaliente/EditaRegla?idRegla=@regla.regla')">
                                                                @regla.nombreRegla (@regla.regla)
                                                            </a>
                                                        </td>
                                                        <td>@grupoAcd</td>
                                                        <td>@prefijo</td>
                                                    </tr>

                                                    inicio = false;
                                                }
                                                else
                                                {
                                                    <tr id="tr_@regla.regla-@item.grupoId">
                                                        <td></td>
                                                        <td> @item.grupoACD </td>
                                                        <td> @item.prefijo </td>
                                                    </tr>
                                                }
                                            }
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            }
        </div>
    </div>

    @Html.Partial("_MiModal", new MiModelDlg())
</div>

@section scripts {

    <script src="~/js/EditGrupoANI.js"></script>
    <script src="~/js/sweetalert2/dist/sweetalert2.all.min.js" type="text/javascript"></script>

    <script>
        let datosGrupoANI = @Html.Raw(Json.Encode(@Model));
        function NuevoRegistro() {
            AvanzarPagina("LlamadaSaliente/GruposDeANIS", "LlamadaSaliente/EditaGrupoANI/0");
        }
    </script>
}